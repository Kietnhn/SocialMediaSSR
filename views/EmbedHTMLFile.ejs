<!DOCTYPE html>
<html lang="en">
    <head>
        <%-include('./partials/Head') %>
        <link rel="stylesheet" href="/css/createPost.css" />
        <style>
            .box-upload-file {
                border: 2px dotted black;

                padding: 16px 24px;
            }
        </style>
    </head>
    <body>
        <div class="vw-100 vh-100 position-relative">
            <div class="position-absolute top-50 start-50 translate-middle">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form
                            method="POST"
                            action="/posts/add/html"
                            enctype="multipart/form-data"
                            id="form-upload-html-file"
                        >
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    Create post by HTML File
                                </h5>
                                <a href="/posts/add">
                                    <button
                                        type="button"
                                        class="btn-close"
                                        id="btn-close"
                                    ></button>
                                </a>
                            </div>
                            <div class="modal-body">
                                <input
                                    type="file"
                                    hidden
                                    name="htmlFile"
                                    id="input-html-file"
                                    accept=".html"
                                />
                                <div
                                    class="box position-relative d-flex flex-column justify-content-between align-items-center rounded box-upload-file"
                                >
                                    <span>
                                        <i
                                            class="fa-solid fa-file-arrow-up fa-lg"
                                        ></i>
                                    </span>
                                    <p>Click here to upload your HTML File</p>
                                    <button
                                        class="btn btn-light"
                                        type="button"
                                        id="btn-open-upload"
                                    >
                                        Browser computer
                                    </button>
                                </div>
                                <!-- <div
                                    class="auto-expand-container position-relative mb-2"
                                >
                                    <div class="placeholder">
                                        What's on your mind
                                    </div>
                                    <div
                                        contenteditable="true"
                                        class="auto-expand"
                                        id="content-editable"
                                    ></div>
                                </div>
                                <input
                                    type="text"
                                    hidden
                                    id="content"
                                    name="content"
                                />
                                <input
                                    type="file"
                                    name="images"
                                    id="imagesInput"
                                    hidden
                                    multiple
                                />
                                <div class="images-preview-warming"></div>
                                <div class="imagePreviews"></div> -->
                                <!-- <div class="box level is-align-items-center">
                                    <div class="level-left">
                                        <p class="title is-6 m-0 feature-title">
                                            Add to your post
                                        </p>
                                    </div>
                                    <div class="level-right">
                                        <button
                                            type="button"
                                            class="btn-icon position-relative"
                                            id="btn-open-file"
                                            onclick="openFileDialog()"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Add Images"
                                        >
                                            <i
                                                class="fas fa-image fa-lg"
                                                style="color: #45bd62"
                                            ></i>
                                        </button>
                                        <button
                                            class="btn-icon"
                                            type="button"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Tag friends"
                                        >
                                            <i
                                                class="fas fa-user-tag fa-lg"
                                                style="color: #1877f2"
                                            ></i>
                                        </button>
                                        <button
                                            class="btn-icon"
                                            type="button"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Add emoji"
                                        >
                                            <i
                                                class="fas fa-face-smile fa-lg"
                                                style="color: #f7b928"
                                            ></i>
                                        </button>
                                        <button
                                            class="btn-icon"
                                            type="button"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Add location"
                                        >
                                            <i
                                                class="fas fa-location-dot fa-lg"
                                                style="color: #f5533d"
                                            ></i>
                                        </button>
                                        <button
                                            class="btn-icon"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                        >
                                            <i
                                                class="bi bi-three-dots-vertical"
                                            ></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <button
                                                    class="dropdown-item"
                                                    type="button"
                                                    id="btn-use-html-file"
                                                >
                                                    <i
                                                        class="fa-brands fa-html5 fa-lg mr-2"
                                                        style="font-size: 24px"
                                                    ></i>
                                                    Embed HTML File
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div> -->
                            </div>

                            <!-- <div class="modal-footer">
                                <% if(errorMessage) {%>
                                <div class="text-danger">
                                    <%= errorMessage%>
                                </div>
                                <% } %>
                                <button
                                    disabled
                                    type="submit"
                                    class="btn btn-primary w-100"
                                    id="btn-create-post"
                                >
                                    Create
                                </button>
                            </div> -->
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal -->

            <!-- <div
                class="modal fade"
                id="staticBackdrop"
                data-bs-backdrop="static"
                data-bs-keyboard="false"
                tabindex="-1"
                aria-labelledby="staticBackdropLabel"
                aria-hidden="true"
            >
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1
                                class="modal-title fs-5"
                                id="staticBackdropLabel"
                            >
                                Embed HTML File
                            </h1>
                            <button
                                type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"
                            ></button>
                        </div>
                        <div class="modal-body">
                            <h6>
                                You must to clean up your content to embed HTML
                                File
                            </h6>
                            <p>
                                Click "Continue" to clean up and embed HTML File
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                            >
                                Cancel
                            </button>
                            <button
                                type="button"
                                class="btn btn-primary"
                                id="btn-continue"
                            >
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
        <script src="/js/jquery-3.7.1.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"
        ></script>
        <!-- <script>
            var tooltipTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="tooltip"]')
            );
            var tooltipList = tooltipTriggerList.map(function (
                tooltipTriggerEl
            ) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        </script> -->
        <script>
            $("#input-html-file").change(() => {
                $("#form-upload-html-file").submit();
            });
            $("#btn-open-upload").click(() => $("#input-html-file").click());
        </script>
        <!-- <script>
            console.log("start create post");
            // contentEditable
            const contentEditable = document.getElementById("content-editable");
            const content = document.getElementById("content");
            const btnCreate = document.getElementById("btn-create-post");
            contentEditable.focus();
            const placeholder = document.querySelector(".placeholder");
            function sanitizeHTML(html) {
                // Use a regular expression to remove HTML tags
                return html.replace(/<[^>]*>/g, "");
            }
            contentEditable.addEventListener("keydown", (event) => {
                if (event.key === "Delete" || event.code === "Delete") {
                    event.preventDefault();
                }
            });

            contentEditable.addEventListener("input", function () {
                const selection = window.getSelection();
                const cursorPosition = selection.getRangeAt(0).startOffset;
                this.style.height = "auto";
                this.style.height = this.scrollHeight + "px";
                if (this.textContent.trim().length === 0) {
                    placeholder.style.display = "block";
                    btnCreate.setAttribute("disabled", "true");
                    this.classList.remove("converted");
                } else {
                    placeholder.style.display = "none";
                    btnCreate.removeAttribute("disabled");
                }

                content.value = this.innerHTML;
                if (!this.classList.contains("converted")) {
                    console.log("sanitize");
                    const text = this.textContent;
                    const sanitizedText = sanitizeHTML(text);
                    this.innerHTML = `<div>${sanitizedText}</div>`;
                    this.classList.add("converted");

                    // Restore the cursor position
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.setStart(this.childNodes[0], cursorPosition);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });

            contentEditable.addEventListener("paste", (event) => {
                event.preventDefault(); // Prevent the default paste behavior

                // Access the clipboard data
                const clipboardData = (event.originalEvent || event)
                    .clipboardData;

                // Check if the clipboard data contains an image
                if (clipboardData && clipboardData.types.includes("Files")) {
                    const files = clipboardData.files;

                    for (const file of files) {
                        if (file.type.startsWith("image/")) {
                            // Image detected in clipboard, prevent the default paste behavior
                            event.preventDefault();
                            alert("Pasting images is not allowed.");
                            break;
                        }
                    }
                }
                const pastedText = clipboardData.getData("text/plain");
                const formattedText = `<div>${pastedText}</div>`;
                document.execCommand("insertHTML", false, formattedText);
            });

            // image
            const openFileDialog = () => {
                imagesInput.click();
            };
            const imagePreviews = document.querySelector(".imagePreviews");
            const imagesInput = document.getElementById("imagesInput");
            const btnOpenFile = document.getElementById("btn-open-file");

            let imagesFile = [];
            let previewFiles = [];
            const renderImagePreviews = (array) => {
                console.log(array);

                if (array.length === 0) {
                    btnCreate.setAttribute("disabled", "true");

                    imagePreviews.classList.remove("wrapper");
                    return;
                }
                if (array.length === 1) {
                    $(".images-preview-warming").html(`
                        <div class="add-file-warming text-warning" >
                            Make sure you select multiple files in the same time
                            </div>

                    `);
                    setTimeout(() => {
                        $(".add-file-warming").remove();
                    }, 3000);
                }
                imagePreviews.innerHTML = ""; // Clear previous previews
                imagePreviews.style.gridTemplateColumns = `repeat(${getTemplate(
                    array.length
                )},1fr)`;
                if (array.length > 4) {
                    btnOpenFile.setAttribute("disabled", "true");
                } else {
                    btnOpenFile.removeAttribute("disabled");
                    btnCreate.removeAttribute("disabled");
                }

                array.forEach((url, index) => {
                    $(".imagePreviews").append(`
                    <figure class="gallery__item--${index + 1}">
                            <button class="btn-icon btn-remove" onclick="handleRemoveImage(${index})" type="button">
                                <i class="fas fa-xmark fa-lg"></i> 
                            </button>
                            <img src="${url}" alt="image preview class="rounded" ${
                        index + 1
                    }" />
                        </figure>
                    `);
                });
            };
            const handleRemoveImage = (index) => {
                imagesFile = imagesFile.filter((_, i) => i !== index);
                previewFiles = previewFiles.filter((_, i) => i !== index);
                renderImagePreviews(previewFiles);
            };
            imagesInput.addEventListener("change", async function (event) {
                // reset preview Files
                previewFiles = [];
                const files = event.target.files;
                console.log({ files });
                if (!files.length > 0) return;

                imagePreviews.classList.add("wrapper");
                imagesFile = [...files];
                console.log({ imagesFile });
                document
                    .getElementById("btn-open-file")
                    .removeAttribute("disabled");
                for (const file of imagesFile) {
                    const dataUrl = await readAsDataURL(file);
                    previewFiles.push(dataUrl);
                }
                renderImagePreviews(previewFiles);
            });
            function readAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            const getTemplate = (length) => {
                if (length >= 3) return (length - 1) * 2;
                return length * 2;
            };
            const formAddPost = document.getElementById("form-add-post");
            btnCreate.onclick = (e) => {
                e.preventDefault();
                content.value = addDivTagToFirstLine(content.value);
                formAddPost.submit();
            };
            const addDivTagToFirstLine = (innerHTML) => {
                const lines = innerHTML.split("<div>");
                let firstLine = lines[0];
                if (!firstLine || firstLine.includes("</div>")) {
                    return innerHTML;
                } else {
                    firstLine = `<div>${firstLine}</div>`;
                    const newLines = [firstLine, ...lines.slice(1)];
                    return newLines.join("<div>").replace("<div></div>", "");
                }
            };
            // btnCreate.onclick = handleCreatePost;
            const btnClose = document.getElementById("btn-close");
            const handleClose = () => {
                window.location.href = "/";
            };
            btnClose.onclick = handleClose;
            const handleNavigateToEmbedHTMLFILE = () => {
                window.location.href = "/posts/add/html";
            };
            // $("#btn-use-html-file").click(() => {
            //     if ($("#content").val() || imagesFile.length > 0) {
            //         $("#staticBackdrop").modal("show");
            //     } else {
            //         handleNavigateToEmbedHTMLFILE();
            //     }
            // });
            // const handleCleanUp = () => {
            //     imagesFile = [];
            //     previewFiles = [];
            //     content.value = "";
            //     contentEditable.innerHTML = "";
            // };
            // $("#btn-continue").click(() => {
            //     handleCleanUp();
            //     handleNavigateToEmbedHTMLFILE();
            // });
        </script> -->
    </body>
</html>
